let visitorId, currentUser = null, currentTheme = localStorage.getItem("theme") || "dark"; document.documentElement.setAttribute("data-theme", currentTheme), document.documentElement.setAttribute("data-bs-theme", currentTheme), (async () => { const e = await FingerprintJS.load(), t = await e.get(); visitorId = t.visitorId, console.log("üîê Device Signature:", visitorId) })(); function toggleTheme() { currentTheme = "dark" === currentTheme ? "light" : "dark", document.documentElement.setAttribute("data-theme", currentTheme), document.documentElement.setAttribute("data-bs-theme", currentTheme), localStorage.setItem("theme", currentTheme); document.getElementById("themeIcon").className = "dark" === currentTheme ? "fas fa-moon" : "fas fa-sun" } function showRegister() { document.getElementById("app").innerHTML = `<div class="auth-container fade-in"><div class="text-center mb-4"><i class="fas fa-user-plus fa-3x" style="color: var(--secondary); opacity: 0.8;"></i></div><h3 class="text-center">Create Account</h3><p class="text-center text-muted small mb-4">Start managing your tasks efficiently</p><form id="registerForm" onsubmit="handleRegister(event)"><div class="mb-3"><label class="form-label">Full Name</label><div class="input-group"><span class="input-group-text bg-transparent border-end-0 border-secondary text-muted"><i class="fas fa-user"></i></span><input type="text" class="form-control border-start-0 ps-0" id="regName" placeholder="John Doe" required minlength="2" maxlength="100"></div></div><div class="mb-3"><label class="form-label">Email Address</label><div class="input-group"><span class="input-group-text bg-transparent border-end-0 border-secondary text-muted"><i class="fas fa-envelope"></i></span><input type="email" class="form-control border-start-0 ps-0" id="regEmail" placeholder="name@example.com" required></div></div><div class="mb-4"><label class="form-label">Password</label><div class="input-group"><span class="input-group-text bg-transparent border-end-0 border-secondary text-muted"><i class="fas fa-key"></i></span><input type="password" class="form-control border-start-0 ps-0" id="regPass" placeholder="Min 6 characters" required minlength="6"></div></div><button type="submit" class="btn btn-success w-100 shadow-lg"><i class="fas fa-rocket me-2"></i>Get Started</button></form><p class="mt-4 text-center text-muted small">Already have an account? <a href="#" onclick="location.reload()" class="fw-bold">Sign In</a></p></div>` } async function handleRegister(e) { e.preventDefault(); const t = document.getElementById("regName").value, a = document.getElementById("regEmail").value, n = document.getElementById("regPass").value; try { const e = await (await fetch("api/register.php", { method: "POST", headers: { "Content-Type": "application/json", "X-Visitor-Id": visitorId }, body: JSON.stringify({ name: t, email: a, password: n }) })).json(); e.success ? (alert("üéâ Account Created Successfully! Please login."), location.reload()) : alert("Error: " + e.message) } catch (e) { console.error(e), alert("Network Error") } } document.getElementById("loginForm")?.addEventListener("submit", async e => { e.preventDefault(); const t = document.getElementById("email").value, a = document.getElementById("password").value, n = document.getElementById("loader"); n.style.display = "block"; try { const e = await (await fetch("api/login.php", { method: "POST", headers: { "Content-Type": "application/json", "X-Visitor-Id": visitorId }, body: JSON.stringify({ email: t, password: a }) })).json(); n.style.display = "none", e.success ? (currentUser = e.user, renderDashboard(e.user)) : alert("Login Failed: " + e.message) } catch (e) { n.style.display = "none", console.error(e), alert("Network Error") } }); function renderDashboard(e) { document.getElementById("app").innerHTML = `<div class="row mb-4"><div class="col-md-8"><div class="dashboard-header fade-in"><div class="d-flex justify-content-between align-items-center"><div><h2 class="fw-bold mb-1">Welcome back, <span style="color: var(--primary)">${e.name}</span></h2><p class="text-muted mb-0"><i class="fas fa-shield-check me-2 text-success"></i>Your tasks are secure</p></div><div><button class="btn btn-outline-secondary btn-sm me-2" onclick="showActivity()"><i class="fas fa-history"></i></button><button class="btn btn-outline-secondary btn-sm me-2" onclick="exportTasks()"><i class="fas fa-download"></i></button><button class="btn btn-outline-danger btn-sm" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Logout</button></div></div></div></div><div class="col-md-4"><div class="stats-card fade-in h-100 d-flex flex-column justify-content-center"><div class="d-flex align-items-center"><i class="fas fa-chart-line fa-2x me-3"></i><div><h3 class="mb-0" id="completedTasks">-</h3><small>Completed / <span id="totalTasks">-</span> Total</small></div></div></div></div></div><div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3"><div class="d-flex align-items-center gap-2"><h4 class="mb-0"><i class="fas fa-list-check me-2"></i>My Tasks</h4><div class="btn-group ms-3"><button class="btn btn-sm btn-outline-secondary active" onclick="filterTasks(null, null, this)">All</button><button class="btn btn-sm btn-outline-danger" onclick="filterTasks('high', null, this)">üî¥ High</button><button class="btn btn-sm btn-outline-warning" onclick="filterTasks('medium', null, this)">üü° Medium</button><button class="btn btn-sm btn-outline-success" onclick="filterTasks('low', null, this)">üü¢ Low</button></div><div class="btn-group ms-2"><button class="btn btn-sm btn-outline-info" onclick="filterTasks(null, 'pending', this)">Pending</button><button class="btn btn-sm btn-outline-success" onclick="filterTasks(null, 'completed', this)">Done</button></div></div><div class="d-flex gap-2"><input type="text" class="search-box" id="searchBox" placeholder="üîç Search tasks..." oninput="searchTasks(this.value)"><button class="btn btn-primary" onclick="openTaskModal()"><i class="fas fa-plus me-2"></i>Add Task</button></div></div><div class="row" id="tasksContainer"><div class="col-12 text-center text-muted py-5"><div class="loader" style="display: block;"></div> Loading tasks...</div></div>`, loadTasks(), loadStats() } let currentPriorityFilter = null, currentStatusFilter = null; async function loadTasks(e = null, t = null, a = null) { try { let n = "api/tasks.php"; const s = new URLSearchParams; e && s.append("search", e), t && s.append("priority", t), a && s.append("status", a), s.toString() && (n += "?" + s.toString()); const o = await (await fetch(n)).json(), l = document.getElementById("tasksContainer"); if (!o.success) return void (l.innerHTML = `<div class="col-12 text-center text-danger">${o.message}</div>`); 0 === o.data.length ? l.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="fas fa-clipboard-list fa-3x mb-3" style="opacity: 0.3;"></i><p>No tasks found. Add your first task!</p></div>' : l.innerHTML = o.data.map(e => `<div class="col-md-4 mb-4"><div class="card h-100 ${"completed" === e.status ? "status-completed" : ""}"><div class="card-body"><div class="d-flex justify-content-between align-items-start mb-2"><span class="priority priority-${e.priority}">${getPriorityEmoji(e.priority)} ${capitalize(e.priority)}</span><span class="status-badge ${"completed" === e.status ? "status-completed-badge" : "status-pending"}">${"completed" === e.status ? "‚úì Done" : "‚è≥ Pending"}</span></div><h5 class="card-title mt-2">${escapeHtml(e.title)}</h5><p class="card-text text-muted small">${escapeHtml((e.description || "").substring(0, 100))}${(e.description || "").length > 100 ? "..." : ""}</p>${e.due_date ? `<p class="due-date mb-0"><i class="fas fa-calendar-alt me-1"></i>Due: ${e.due_date}</p>` : ""}</div><div class="card-footer bg-transparent border-secondary d-flex justify-content-between align-items-center"><small class="text-muted"><i class="fas fa-clock me-1"></i>${e.created_at}</small><div><button class="btn btn-sm btn-outline-success me-1" onclick="toggleTask('${e.id}')" title="Toggle Status"><i class="fas fa-check"></i></button><button class="btn btn-sm btn-outline-primary me-1" onclick="editTask('${e.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${e.id}')"><i class="fas fa-trash"></i></button></div></div></div></div>`).join("") } catch (e) { console.error(e), document.getElementById("tasksContainer").innerHTML = '<div class="col-12 text-center text-danger">Failed to load tasks</div>' } } async function loadStats() { try { const e = await (await fetch("api/tasks.php?action=stats")).json(); e.success && (document.getElementById("totalTasks").textContent = e.data.total, document.getElementById("completedTasks").textContent = e.data.completed) } catch (e) { console.error(e) } } function filterTasks(e, t, a) { null !== e && (currentPriorityFilter = e), null !== t && (currentStatusFilter = t), loadTasks(null, currentPriorityFilter, currentStatusFilter) } let searchTimeout; function searchTasks(e) { clearTimeout(searchTimeout), searchTimeout = setTimeout(() => { loadTasks(e, currentPriorityFilter, currentStatusFilter) }, 300) } function openTaskModal(e = null) { document.getElementById("taskId").value = e || "", document.getElementById("taskTitle").value = "", document.getElementById("taskDescription").value = "", document.getElementById("taskPriority").value = "medium", document.getElementById("taskDueDate").value = "", document.getElementById("taskModalTitle").innerHTML = e ? '<i class="fas fa-edit me-2"></i>Edit Task' : '<i class="fas fa-plus me-2"></i>Add Task', new bootstrap.Modal(document.getElementById("taskModal")).show() } async function editTask(e) { try { const t = await (await fetch(`api/tasks.php?action=single&id=${e}`)).json(); if (t.success) { const e = t.data; document.getElementById("taskId").value = e.id, document.getElementById("taskTitle").value = e.title, document.getElementById("taskDescription").value = e.description || "", document.getElementById("taskPriority").value = e.priority, document.getElementById("taskDueDate").value = e.due_date || "", document.getElementById("taskModalTitle").innerHTML = '<i class="fas fa-edit me-2"></i>Edit Task', new bootstrap.Modal(document.getElementById("taskModal")).show() } } catch (e) { console.error(e), alert("Failed to load task") } } async function saveTask() { const e = document.getElementById("taskId").value, t = document.getElementById("taskTitle").value, a = document.getElementById("taskDescription").value, n = document.getElementById("taskPriority").value, s = document.getElementById("taskDueDate").value; if (!t.trim()) return void alert("Title is required"); try { const o = e ? "PUT" : "POST", l = e ? { id: e, title: t, description: a, priority: n, due_date: s } : { title: t, description: a, priority: n, due_date: s }, i = await (await fetch("api/tasks.php", { method: o, headers: { "Content-Type": "application/json" }, body: JSON.stringify(l) })).json(); i.success ? (bootstrap.Modal.getInstance(document.getElementById("taskModal")).hide(), loadTasks(null, currentPriorityFilter, currentStatusFilter), loadStats()) : alert("Error: " + i.message) } catch (e) { console.error(e), alert("Failed to save task") } } async function toggleTask(e) { try { const t = await (await fetch(`api/tasks.php?action=toggle&id=${e}`)).json(); t.success ? (loadTasks(null, currentPriorityFilter, currentStatusFilter), loadStats()) : alert("Error: " + t.message) } catch (e) { console.error(e), alert("Failed to toggle task") } } async function deleteTask(e) { if (!confirm("‚ö†Ô∏è Are you sure you want to delete this task?")) return; try { const t = await (await fetch(`api/tasks.php?id=${e}`, { method: "DELETE" })).json(); t.success ? (loadTasks(null, currentPriorityFilter, currentStatusFilter), loadStats()) : alert("Error: " + t.message) } catch (e) { console.error(e), alert("Failed to delete task") } } async function showActivity() { try { const e = await (await fetch("api/tasks.php?action=activity")).json(), t = document.getElementById("activityContent"); e.success && e.data.length > 0 ? t.innerHTML = e.data.map(e => `<div class="activity-item"><strong>${formatAction(e.action)}</strong><p class="mb-0 small text-muted">${e.details}</p><small class="text-muted">${e.timestamp}</small></div>`).join("") : t.innerHTML = '<p class="text-muted text-center">No activity yet</p>', new bootstrap.Modal(document.getElementById("activityModal")).show() } catch (e) { console.error(e) } } async function exportTasks() { try { const e = await (await fetch("api/tasks.php?action=export")).json(); if (e.success) { const t = new Blob([JSON.stringify(e.data, null, 2)], { type: "application/json" }), a = URL.createObjectURL(t), n = document.createElement("a"); n.href = a, n.download = "taskflow_export.json", n.click(), URL.revokeObjectURL(a) } } catch (e) { console.error(e), alert("Failed to export") } } function escapeHtml(e) { const t = document.createElement("div"); return t.textContent = e || "", t.innerHTML } function getPriorityEmoji(e) { return { high: "üî¥", medium: "üü°", low: "üü¢" }[e] || "‚ö™" } function capitalize(e) { return e.charAt(0).toUpperCase() + e.slice(1) } function formatAction(e) { return { task_created: "üìã Task Created", task_updated: "‚úèÔ∏è Task Updated", task_deleted: "üóëÔ∏è Task Deleted", task_status_changed: "‚úÖ Status Changed", tasks_exported: "üì§ Tasks Exported", login: "üîì Login" }[e] || e }
